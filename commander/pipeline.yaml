---
resources:
- name: pipelines-source
  type: git
  icon: github
  source:
    uri: https://github.com/rbogle/test-concourse-pipelines
    branch: main

- name: pipeline-locks
  type: pool
  source:
    uri: git@github.com:rbogle/concourse-locks.git
    branch: main
    pool: controller
    private_key: ((git_key)) #ssh key

jobs:
- name: lock-pipeline
  plan:
  - get: pipelines-source
    trigger: true
  - put: pipeline-locks
    params: {claim: main-pipeline}

- name: set-self
  plan:
  - get: pipelines-source
    trigger: true
    passed: [lock-pipeline]
  - set_pipeline: self
    file: pipelines-source/deployer/pipeline.yaml
    vars: 
      git_key: ((git_key))

- name: build-environment-controller
  plan:
  - get: pipeline-locks
  - get: pipelines-source
    trigger: true
    passed: [set-self]
  - set_pipeline: environment-pipeline-builder
    file: pipelines-source/controller/controller-pipeline.yaml
    var_files:
      - pipelines-source/controller/controller-vars.yaml
    vars: 
      git_key: ((git_key))
  - put: pipeline-locks
    params: {release: pipeline-locks}